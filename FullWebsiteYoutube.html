<!DOCTYPE html> 
<html> 

<!-- SETTINGS -->
<head>
  <meta charset=utf-8>
  <link href='https://fonts.googleapis.com/css?family=Rubik' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="stylesheet1.css">
  <style type="text/css">
  </style>
</head>


<body>
  <!-- HEADER -->
  <header>
    <span class="title">
      <h1 class="song_title">
        Бременские музыканты <sup onclick='openCloseSongInfo()'class="info_circle">ⓘ</sup>
      </h1>
    </span>

    <div class="song_info" id="song_info" style="display: none">
       <button class="open_close_button song_info_close_button" onclick="openCloseSongInfo()">✕</button>
      <ul style="list-style: none;">
        <li><span class="strong">Авторы мультфильма:</span> Василий Ливанов, Юрий Энтин, ...</li>
        <li><span class="strong">Оригинальные исполнители:</span> Олег Анофриев, Муслим Магомаев, ...</li>
        <li>Перевод и исполнение: неизвестны</li>
        <li>
           Источник:
          <a href="https://www.facebook.com/100068139504179/videos/%D0%B1%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D1%81%D0%BA%D0%B8%D0%B5-%D0%BC%D1%83%D0%B7%D1%8B%D0%BA%D0%B0%D0%BD%D1%82%D1%8B-%D0%BD%D0%B0-%D0%B8%D0%B2%D1%80%D0%B8%D1%82%D0%B5/1540622656206008/" target="_blank"> ➥ </a>
        </li>
        </ul>
    </div>
  </header>

<!-- OPEN/CLOSE ELEMENTS -->
<script>
  function openCloseMenu() {
    var button = document.getElementById("menu_button");
    var menu = document.getElementById("menu_list");
    if (button.dataset.open === "closed") {
      menu.style.display = "block";
      button.innerHTML = "✕";
      button.dataset.open = "open";
    }
    else {
      menu.style.display = "none";
      button.innerHTML = "☰";
      button.dataset.open = "closed";
    }
  }

  function openCloseContents() {
    var button = document.getElementById("contents_button");
    var contents = document.getElementById("contents_list");
    if (button.dataset.open === "closed") {
      contents.style.display = "block";
      button.innerHTML = "✕ Песни в мультфильме";
      button.dataset.open = "open";
    }
    else {
      contents.style.display = "none";
      button.innerHTML = "☰ Песни в мультфильме";
      button.dataset.open = "closed";
    }
  }

  function openCloseSongInfo() {
    var song_info = document.getElementById("song_info");
    if (song_info.style.display === "block") {
      song_info.style.display = "none";
    }
    else {
      song_info.style.display = "block";
    }
  }
</script>


<!-- HTML CONTENT -->
<div style="float: left;">
  <button id="menu_button" class="open_close_button" onclick="openCloseMenu();" data-open="closed">☰</button>
</div>
<div style="float: right;">
    <button id="contents_button" class="open_close_button" onclick="openCloseContents();" data-open="closed">☰ Песни в мультфильме</button>
</div>
<div class="content_container">
  <!-- MENU COLUMN --->
  <div class="content_column list_of_contents" id="menu_list" style="display: none">
    <a href="/">☜ Главная страница</a>
    <h3>Песни на сайте</h3>
      <ul>
        <li><a href="/song/BremenMusicians">Бременские музыканты</a></li>
         <li>... скоро будут!</li>
      </ul>
  </div>

  <!-- VIDEO COLUMN --->
  <div class="content_column video_column">
    <div class="my_controls">
      <button onclick="playPause()">▶</button> 
      <button onclick="setSpeed(0.5)">0.5</button> 
      <button onclick="setSpeed(0.75)">0.75</button> 
      <button onclick="setSpeed(1)">1</button>
      <button onclick="goForward(-3)">⤾ 3 сек.</button>
      <button onclick="goForward(3)">⤿ 3 сек.</button>
    </div id="my_controls">

    <!-- video -->
    <div id="video_wrap" class="video_wrap">
      <div id="the_video">
        <!-- THE VIDEO IS HERE -->
      </div>
    </div>

    <!-- subtitles HE -->
    <div id="subtitles_he_wrap" class="subtitles_wrap">
        <div id="subtitles_he" class="subtitles" dir="rtl">
          <!-- here are the Hebrew subtitles -->
        </div>
    </div>

    <!-- subtitles RU -->
    <div id="subtitles_ru_wrap" class="subtitles_wrap">
        <div id="subtitles_ru" class="subtitles">
          <!-- here are the Russian subtitles -->
        </div>
    </div>
  </div>

  <!-- CONTENTS COLUMN -->
  <div class="content_column contents_column" id="contents_list" style="display: none">
    <h3>Песни в мультфильме</h3>
    <p>Нажмите, чтобы перейти к песне:</p>
    <div id="video_moments">
      <ul>
        <li/> <button onclick="setTime(0, 1)">Песня друзей</button> 
        <li/> <button onclick="setTime(6, 25)">В клетке птичка томится</button> 
        <li/> <button onclick="setTime(7, 53)">Говорят, мы бяки-буки</button> 
        <li/> <button onclick="setTime(10, 11)">Ох, рано встаёт охрана!</button>
        <li/> <button onclick="setTime(11, 49)">Пиф-паф, и вы покойники</button>
        <li/> <button onclick="setTime(13, 43)">Куда ты, тропинка</button>
        <li/> <button onclick="setTime(21, 19)">Я гениальный сыщик</button>
        <li/> <button onclick="setTime(22, 10)">Что за дети нынче, право</button>
        <li/> <button onclick="setTime(27, 50)">Луч солнца золотого</button>
        <li/> <button onclick="setTime(30, 20)">Ничего я не хочу</button>
        <li/> <button onclick="setTime(32, 12)">Романтики с большой дороги</button>
      </ul>
    </div>
  </div>
    
  

<!-- OPENING/CLOSING ACCORDING TO DEVICE SIZE -->
<script>
  if (window.matchMedia("(min-width: 800px)").matches) {
    openCloseMenu(); // will open
  }
  if (window.matchMedia("(min-width: 1200px)").matches) {
    openCloseContents(); // will open
  }
</script>

<!-- VIDEO CONTROLS CALLBACKS -->
<script>
  var myVideo = document.getElementById("the_video");
  var hoveredSubtitles = false;

  function playPause() {
    if (player.getPlayerState() == 1) { // playing
      player.pauseVideo();
    }
    else {
      player.playVideo();
    }
  }

  function setSpeed(newSpeed) {
    player.setPlaybackRate(newSpeed);
  }

  function goForward(sec) {
    player.seekTo(player.playerInfo.currentTime + sec);
  }

  function setTime(min, sec) {
    player.seekTo(min * 60 + sec);
  }

  function showControls() {
    myVideo.controls = true;
  }

  function hideControls() {
    myVideo.controls = false;
  }

  function subtitlesHover() {
    if (!myVideo.paused) {
      hideControls(); // otherwise they annoyingly show
      myVideo.pause();
      hoveredSubtitles = true;
    }
  }

  function subtitlesUnHover() {
    if (hoveredSubtitles) {
      hideControls(); // otherwise they annoyingly show
      myVideo.play();
      hoveredSubtitles = false;
    }
  }
</script>

<!-- ANALYSIS FILE -->
<script type="text/javascript" src="media/analysis/BremenMusicians_analysis.json"></script>

<!-- VTT-TO-JSON LIBRARY -->
<script src="https://unpkg.com/vtt-to-json@0.1.1/index.js"></script>

<!-- VIDEO AND SUBTITLES FUNCTIONS -->
<script>
  // Includes Youtube API
  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/player_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  // Includes video
  var player;

  function onYouTubePlayerAPIReady() {
    player = new YT.Player('the_video', {
      videoId: 'Hlbxl3rNLN8'
    });
  }

  // fetch and parse the .vtt file using vtt.js
  async function fetchAndParseVTT(vttUrl) {
    const response = await fetch(vttUrl);
    const vttText = await response.text();
    return convertVttToJson(vttText);
  }

  function getSubtitleAtTime(cues, currentTimeInSeconds) {
    const currentCue = cues.find(cue => (currentTimeInSeconds >= cue.start) && (currentTimeInSeconds <= cue.end));
    return currentCue ? currentCue.part : '';
  }

  const vttUrl = 'media/subtitles/BremenMusicians_Hebrew.vtt';

  var cues = fetchAndParseVTT(vttUrl).then(cues => {
    var subtitles_wrap_id = 'subtitles_he_wrap';
    var div1 = document.getElementById("subtitles_he");
    function showSubtitlesByTime() {
      line = getSubtitleAtTime(cues, player.playerInfo.currentTime * 1000);
      div1.innerHTML = makeInteractive(line);
      div1.dataset.line = line;
      if (div1.dataset.line != line) {
        div1.innerHTML = makeInteractive(line);
        div1.dataset.line = line;
      }
    }
    var t = setInterval(showSubtitlesByTime, 100);
  });

  const vttUrl_ru = 'media/subtitles/BremenMusicians_Russian.vtt';

  var cues_ru = fetchAndParseVTT(vttUrl_ru).then(cues_ru => {
    var div_ru = document.getElementById("subtitles_ru");
    function showSubtitlesByTime() {
      line = getSubtitleAtTime(cues_ru, player.playerInfo.currentTime * 1000);
      if (div_ru.dataset.line != line) {
        div_ru.innerHTML = line;
        div_ru.dataset.line = line;
      }
    }
    var t_ru = setInterval(showSubtitlesByTime, 100);
  });

  function show(data) {
    if (!data) {
      return "";
    }
    return data;
  }

  function show_suff(suffix) {
    if (!suffix) {
      return "";
    }
    return "+ " + suffix;
  }

  function designAnalysis(word) {
    return `<span class="tooltip">
        ${word.word} <span class="tooltiptext_analysis">
        <table class="word_analysis_table">
      <tr>
        <td class="heb_td">
        ${show(word.prefix)}
        ${show(word.lemma)}
        ${show_suff(word.suffix)}
        </td>
      </tr>
      <tr>
        <td>${show(word.pattern)}</td>
      </tr>
      <tr>
        <td class="heb_td">${show(word.root)}</td>
      </tr>
      <tr>
        <td class="translation">${show(word.translation)}</td>
      </tr>
    </table>
    </span>
    </span>`;
  }

  function makeInteractive(line) {
    let new_line = "";
    let words = analysis.filter(item => item.line === line);
    if (words.length > 0) {
      for (let word of words) {
        new_line += designAnalysis(word) + " ";
      }
      return new_line;
    }
    return line;
  }
</script>


</body>
</html>